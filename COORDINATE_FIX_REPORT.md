# 座標変換修正レポート

## 修正日時
2025年11月9日

## 問題の概要

恒星名の位置が完全に間違っており、一部の恒星が天球の回転に追従せず独自に動いていた。

---

## 根本原因

### 単位変換の欠落

**問題のコード:**
```javascript
const coords = window.labeledStars.map(star => {
  let { x, y, z } = toHorizontal(star.ra, star.dec, angle);
  ({ x, y, z } = applyAllRotations(x, y, z));
  return { name: star.name, x, y, z };
});
```

**問題点:**
- `LABELED_STARS` の赤経（RA）は「時間」単位（例: 6.75h）
- `LABELED_STARS` の赤緯（Dec）は「度」単位（例: -16.7°）
- しかし、`toHorizontal()` 関数は**ラジアン**を期待している
- 変換せずに渡していたため、座標が完全に間違っていた

### 具体例（Sirius）

| 項目 | 値 |
|------|-----|
| カタログ値 | RA = 6.75h, Dec = -16.7° |
| 誤った処理 | 6.75ラジアン ≈ 387° として計算 |
| 正しい処理 | 6.75h → 101.25° → 1.77ラジアン |

---

## 修正内容

### 修正後のコード

```javascript
const coords = window.labeledStars.map(star => {
  // 赤経：時間 → ラジアン (24h = 2π rad)
  const raRad = (star.ra / 24) * 2 * Math.PI;
  // 赤緯：度 → ラジアン
  const decRad = (star.dec * Math.PI) / 180;
  
  let { x, y, z } = toHorizontal(raRad, decRad, angle);
  ({ x, y, z } = applyAllRotations(x, y, z));
  return { name: star.name, x, y, z };
});
```

### 変換式

**赤経（RA）: 時間 → ラジアン**
```
raRad = (ra / 24) × 2π
```
- 24時間 = 360° = 2π ラジアン
- 例: 6.75h = (6.75/24) × 2π ≈ 1.77 rad

**赤緯（Dec）: 度 → ラジアン**
```
decRad = dec × π / 180
```
- 180° = π ラジアン
- 例: -16.7° = -16.7 × π/180 ≈ -0.29 rad

---

## 修正結果

### ✅ 修正前の問題

❌ 恒星名の位置が完全に間違っている  
❌ 一部の恒星が独自に動く  
❌ 恒星名が対応する恒星と一致しない

### ✅ 修正後の状態

✅ すべての恒星名が正しい位置に表示される  
✅ すべての恒星名が天球の回転に正しく追随する  
✅ 恒星名が対応する恒星の近くに配置される  
✅ 奥行き暗化も正しく適用される

---

## テスト結果

### 視覚的確認

以下の恒星名が正しい位置に表示されることを確認：

- **Sirius** - 南東部の最も明るい恒星の近く
- **Capella** - 中央東部の明るい恒星の近く
- **Rigel** - 東部の明るい恒星の近く
- **Betelgeuse** - 東部の明るい恒星の近く
- **Aldebaran** - 東部の明るい恒星の近く
- **Polaris** - 中央北部（北極星）の近く
- **Deneb** - 北西部の明るい恒星の近く
- **Fomalhaut** - 中央の恒星の近く
- **Alpheratz** - 北部の明るい恒星の近く
- **Mirach** - 北東部の恒星の近く
- **Schedar** - 北部の恒星の近く
- **Hamal** - 東部の恒星の近く

### 回転追随テスト

✅ 水平回転に追随  
✅ 南北回転に追随  
✅ 東西回転に追随  
✅ アニメーション中も正しく追随

---

## Git情報

- **ブランチ**: `manus/star-names2`
- **コミット**: `58e31fe`
- **プッシュ**: 完了

---

## 教訓

### 座標系の単位に注意

天文計算では、複数の単位系が混在する：
- **赤経**: 時間（0h-24h）または度（0°-360°）
- **赤緯**: 度（-90°～+90°）
- **三角関数**: ラジアン（0～2π）

関数に渡す前に、必ず単位を確認し、必要に応じて変換する。

### コードレビューの重要性

今回の問題は、コードレビューで即座に指摘された。単位変換のミスは、視覚的には分かりにくいが、コードを読めば明らかである。

---

## 次のステップ

プルリクエストを作成してレビューを依頼してください：  
https://github.com/astrogrammar/sphere10/pull/new/manus/star-names2

修正は完了し、すべての機能が正常に動作しています。
