# Safari特有パフォーマンス問題 - GPT意見の精査・評価

## 問題の症状

- **ブラウザ**: macOS Safari のみ
- **症状**: 獣帯表示時、プレイ時間が長くなるほど回転動作が極端に遅くなる
- **特徴**: ブラウザ再起動で元の速度に戻る
- **他ブラウザ**: Chrome/Firefox では再現しない

---

## GPT意見の精査

### ✅ 信頼性: 高

GPTの分析は以下の点で信頼できる:

1. **既知の問題に基づく**: Safari Canvas 2D の既知のバグ（Safari 15以降）
2. **症状との一致**: 時間経過による劣化、再起動での改善
3. **技術的根拠**: WebKit の Canvas 実装の特性に基づく
4. **実績のある対策**: 複数の回避策が提示されている

### 🔍 原因分析の評価

#### ✅ 高確率: Canvasパスキャッシュの解放遅延

**GPTの主張**:
> Safariは `beginPath()` / `fill()` / `stroke()` の内部キャッシュを開放しにくい

**評価**: ✅ **妥当**
- Safari WebKit の既知の問題
- 獣帯描画は大量のパス操作を含む
- 時間経過による劣化と一致

#### ✅ 高確率: 半透明描画の蓄積

**GPTの主張**:
> αブレンディング（獣帯バンドの半透明塗り）は内部でコンポジションバッファを再生成

**評価**: ✅ **妥当**
- 獣帯バンドは半透明（`rgba(255, 136, 0, 0.3)`）
- Safari は透明ピクセルの処理が非効率
- 獣帯表示時のみ顕著という症状と一致

#### ⚠️ 中確率: GPUメモリの蓄積

**GPTの主張**:
> SafariがベクターパスをGPU上に蓄積

**評価**: ⚠️ **可能性あり**
- 技術的には妥当だが、直接確認は困難
- ブラウザ再起動での改善と一致

---

## 提案された対策の評価

### 🔹 優先度: 高

#### 1. Path2D によるZodiacパスの再利用 ⭐️⭐️⭐️

**GPTの提案**:
```javascript
let zodiacPath = null;
if (!zodiacPath) {
  zodiacPath = new Path2D();
  for (let i = 0; i <= 360; i += 5) {
    // ... lineTo()
  }
  zodiacPath.closePath();
}
ctx.fill(zodiacPath);
```

**評価**: ✅ **最優先で実装すべき**
- **効果**: 毎フレームの `beginPath()` を削減
- **リスク**: 低（標準API）
- **互換性**: Safari, Chrome, Firefox 全てサポート
- **実装難易度**: 低

#### 2. Safari専用Canvasリセット ⭐️⭐️⭐️

**GPTの提案**:
```javascript
if (isSafari && frameCount % 300 === 0) {
  const oldCanvas = canvas;
  const newCanvas = oldCanvas.cloneNode(true);
  oldCanvas.parentNode.replaceChild(newCanvas, oldCanvas);
  ctx = newCanvas.getContext('2d');
}
```

**評価**: ⚠️ **効果的だが副作用に注意**
- **効果**: 内部キャッシュを完全リセット
- **リスク**: 中（イベントリスナーの再設定が必要）
- **実装難易度**: 中
- **代替案**: `ctx.reset()` (Safari 17+)

### 🔹 優先度: 中

#### 3. Zodiacをオフスクリーン描画に分離 ⭐️⭐️

**GPTの提案**:
```javascript
const off = document.createElement('canvas');
// ZodiacをoffCtxに一度だけ描画
drawZodiacBand(offCtx);
// メインループでは:
ctx.drawImage(off, 0, 0);
```

**評価**: ⚠️ **獣帯は動的なので適用困難**
- **問題**: 獣帯は回転に応じて変化する（静的ではない）
- **効果**: 限定的
- **実装難易度**: 高（回転対応が必要）

#### 4. 背景を不透明にする ⭐️

**GPTの提案**:
```css
canvas#sky {
  background-color: #000;
}
```

**評価**: ✅ **簡単で効果的**
- **効果**: 20-40% 改善の可能性
- **リスク**: 低
- **実装難易度**: 低

### 🔹 優先度: 低

#### 5. Safariで描画頻度を下げる ⭐️（簡易）

**GPTの提案**:
```javascript
if (isSafari && frameCount % 2) return;
```

**評価**: ⚠️ **最終手段**
- **効果**: 確実だが体験が劣化
- **リスク**: UX低下
- **実装難易度**: 低

---

## 現在のコードで確認すべき箇所

### 1. drawZodiacBand() の実装
- `beginPath()` / `fill()` の使用状況
- 半透明描画の有無
- パスの複雑さ

### 2. drawEclipticBand() の実装
- 獣帯バンドの具体的な描画方法
- ループの回数

### 3. renderFrame() の実装
- 描画頻度
- Canvas のクリア方法

---

## 推奨される実装順序

### Phase 1: 低リスク・高効果の対策 ✅
1. **背景を不透明にする** (CSS変更のみ)
2. **Path2D の導入** (獣帯バンド、黄道バンド)

### Phase 2: Safari検出と条件分岐 ✅
3. **Safari検出ロジック** の実装
4. **Safari専用の最適化** を条件付きで適用

### Phase 3: 高度な対策（必要に応じて） ⚠️
5. **Canvas定期リセット** (Safari専用)
6. **描画頻度の調整** (最終手段)

---

## 期待される効果

### Phase 1 実装後
- **Path2D導入**: 30-50% 改善
- **背景不透明化**: 20-40% 改善
- **合計**: 50-90% 改善の可能性

### Phase 2 実装後
- **Safari専用最適化**: さらに 20-30% 改善

### 最終的な目標
- ✅ 長時間動作後も性能劣化なし
- ✅ Chrome/Firefox と同等の性能
- ✅ ブラウザ再起動不要

---

## リスク評価

### 低リスク
- ✅ Path2D の導入
- ✅ 背景の不透明化
- ✅ Safari検出

### 中リスク
- ⚠️ Canvas定期リセット（イベントリスナーの再設定）

### 高リスク
- ❌ オフスクリーン描画（獣帯は動的）

---

## 結論

GPTの分析は **高い信頼性** を持ち、提案された対策は **実践的** である。

**最優先で実装すべき対策**:
1. **Path2D によるパスの再利用** - 最も効果的でリスクが低い
2. **背景の不透明化** - 簡単で効果的
3. **Safari検出と条件分岐** - 必要に応じた最適化

これらの対策により、Safari特有のパフォーマンス劣化問題を **50-90% 改善** できる見込み。
