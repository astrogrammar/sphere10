# Sphere10 立体天球ホロスコープ v3.0

**Time Control Architecture & Floating UI Update**
**独立型タイムコントロールパネル + 多重解像度時間操作 + UI/ロジック分離**

## 概要
Sphere10は、古典占星術向けの3D天球シミュレーターです。
v3.0では、日時操作系を独立した「フローティングウィンドウ」に刷新し、分・時・日・月・年単位での自在な時間旅行（Time Travel）が可能になりました。また、内部構造を疎結合アーキテクチャへ移行し、保守性と拡張性が飛躍的に向上しています。

## 🏗️ v3.0 アーキテクチャ：ロジックの完全分離 (Major Refactoring)

v3.0では、アプリケーションの肥大化に伴う保守性の課題を解決するため、役割に応じたロジックの切り分け（Separation of Concerns）を徹底しました。

### 📁 JSファイルの役割と設計思想

| ファイル名 | 役割 / ロジックの切り分け | 詳細説明 |
| :--- | :--- | :--- |
| `sphere10.js` | **3D描画・天体計算コア** | 天体位置の算出とCanvasへの描画（レンダリングループ）に特化。UI操作ロジックを排除。 |
| `timeControl.js` | **時間軸管理・VCR制御** | フローティングパネルの挙動、自動再生、分〜年単位のステップ移動を独立して制御。 |
| `utilities.js` | **汎用UI・ツールユーティリティ** | スクリーンショット撮影、ドックアイコンの連動、非天文計算系のイベントリスナーを集約。 |
| `chart.js` | **2Dホロスコープ表示** | 独立した2Dチャートエンジン。`sphere10.js`の計算結果を同期してオーバーレイ表示。 |
| `lunarOrbit.js` | **白道計算演算** | 月の軌道面の傾斜と18.6年周期の交点移動を計算する専用ジオメトリエンジン。 |
| `precession.js` | **歳差補正エンジン** | IAU 1976モデルに基づき、J2000座標から指定日時への精密な座標変換行列を生成。 |
| `store.js` | **永続化データ管理** | `localStorage` を通じた設定値の保存・復元。各モジュールから利用可能なデータ層。 |

### 🛠️ 技術的ブレイクスルーと新機能

1. **Bridge Pattern による疎結合設計**:
   `window.Sphere10` APIをブリッジとして、`timeControl.js` が描画コアの内部構造を意識せずに日時を更新できる、拡張性の高い連携を実現しました。
2. **CSS State Pattern によるバイリンガル対応**:
   日英切り替えをJavaScriptによるテキスト書き換えではなく、`body`クラス（`.locale-ja`）とCSSセレクタのみで制御。負荷ゼロかつ瞬時の言語切替を可能にしました。
3. **SVG Inline Standardization (Material Design)**:
   Time Controlや右下ドックのアイコンを、OS依存の絵文字から線画SVGへ統一。Windows/Mac/iOS/Androidの全環境で一貫したプロフェッショナルな視覚体験を提供します。
4. **Dock Launcher System**:
   画面右下に [D]日時, [S]恒星, [☿]惑星/チャート, [📸]撮影を集約。SVG化されたミニマルなアイコン群により、天球の観察を妨げない直感的な操作感を実現。
5. **UIの視覚的ブラッシュアップ**:
   チェックボックスのFlexboxによる垂直整列や、グラスモーフィズム（透過ブラー効果）の最適化により、精密機器のような質感へと進化。

## 🏗️ v4.0 最新アップデート：3Dハウスシステム・エンジン (Major Update)

v4.0では、占星術の根幹となるハウス分割を3D天球上に完全に統合しました。静的な大円描画だけでなく、時間分割に基づいた動的な曲線演算を実装しています。

### 🏠 実装済みハウスシステム (House Systems)

| システム | 幾何学的定義 | 特徴 |
| :--- | :--- | :--- |
| **Placidus** | 時間分割 (Semi-diurnal Arc) | 3D空間ではS字状の曲線を描く。反復計算により精密に再現。 |
| **Campanus** | 卯酉線 (Prime Vertical) の等分 | 南北点を結ぶ。3D空間で最も幾何学的な「分割」を実感できる。 |
| **Regiomontanus** | 天の赤道の等分 | 赤道上の30度刻みの点を地平座標に投影。古典的な標準方式。 |
| **Equal (AC)** | 黄道の等分 (アセンダント起点) | ACから30度ずつ黄道に沿って分割。黄道座標系に基づく。 |
| **Whole Sign** | サイン境界の同期 | ACのサイン0度を起点とする。サインの境界線と一致。 |

### 🛠️ 技術的ブレイクスルー (v4.x)
1. **Iterative Curve Calculation (Placidus)**: 
   プラシーダス特有のS字曲線を、赤緯（Dec）ごとの時角を数値的に逆算することで、滑らかな3D曲線として描画。
2. **Point Symmetry Optimization**: 
   天球の中心を介した点対称（Antipodal mapping）を利用し、対向ハウス（例: 11-5, 12-6）を最小の計算負荷で正確に整合。
3. **Visual Alignment of Angles**: 
   アングル（1, 4, 7, 10）のラベルを、視認性向上のため天の赤道と地平線・子午線の交点付近へ動的に配置。
4. **House Persistence**: 
   `store.js` を拡張し、ユーザーが選択したハウスシステムの状態をリロード後も完全に維持。

## 🚀 v2.1 最新アップグレード内容

## 🚀 v3.0 アーキテクチャの完成とクリーンアップ（2025/12/24 実装）

### 🏗️ 脱レガシー：イベント駆動型アーキテクチャへの完全移行
v3.0の設計思想に基づき、古い世代のDOM依存ロジックを完全に排除しました。
- **Hidden Inputの廃止**: `index.html` から `datetimeInput` (hidden) を削除。
- **Event-Driven同期**: `sphere10.js` が計算完了時に `sphere10:update` カスタムイベントを発火し、`chart.js` や `utilities.js` がそれを購読する方式へ転換。
- **APIの一本化**: `window.Sphere10.setDate / getDate` を唯一の真実（Single Source of Truth）として定義。
- **ゴーストコードの削除**: `sphere10.js` 内に残留していた旧世代の日付送りロジック（`changeDateByDays` 等）をすべて清算。

### 🎨 視覚的演出：黄緯スケーリングの強調
2Dホロスコープチャートにおいて、天体の垂直方向の動き（黄緯）を視覚的に強調するアップデートを行いました。
- **冥王星対応スケーリング**: 冥王星の最大黄緯（約17.2° / 1975年4月等）を基準に、チャート内に収まる限界係数 **`2.3`** を採用。
- **実装ロジック**: `const latScale = 1 + (lat / 90) * 2.3;` により、黄道から離れた天体がダイナミックにリング内外へ移動する演出を実現。

### ⚡ パフォーマンス最適化
- **Smart Guardの実装**: 重複する再計算を防ぐため、API経由の更新時には1秒未満の微小な時間差を無視するガードロジックを `sphere10.js` に導入。
- **イベントの整理**: 負荷の原因となっていた `input` イベントの冗長な発火を停止。


### 🌌 LST（地方恒星時）による天球回転（2025/12/15 新規実装）
- **天文学的な正確性**: `Astronomy.SiderealTime()` を使用してGAST（グリニッジ視恒星時）を計算し、観測地の経度を加えてLSTを算出
- **天球の自動回転**: LSTに基づいて天球全体を自動的に回転させ、時刻と天体の位置を正確に同期
- **太陽の南中**: 東京（経度139.65°）で、太陽が11:46 JSTに子午線上を通過（南中）することを再現
- **恒星時の速度**: 天球が1時間で約15度回転する、地球の自転に基づいた正確な速度を実装

## 🚀 v2.0 既存機能

### 📅 日付送り機能（2025/11/06 新規実装）
- **手動日付送り**: ◀/▶ボタンで1日単位で過去/未来へ移動
- **自動日付送り**: ◀◀/▶▶ボタンで0.5秒ごとに1日ずつ自動送り
- **停止ボタン**: ■ボタンで自動送りを停止
- **Todayボタン**: 現在時刻にリセット
- **chartCanvas連携**: 日付変更時にホロスコープチャートも自動更新
- **UIデザイン**: 既存のPLAY/STOPボタンと統一されたデザイン（青グラデーション）

### 🎨 日付送り機能の特徴
- **視覚的フィードバック**: アクティブなボタンは青グラデーションで表示
- **直感的な操作**: 音楽プレーヤーのような馴染みのあるUI
- **天体位置の自動更新**: 日付変更時にエフェメリス計算が自動実行
- **ホロスコープチャート同期**: chartCanvasが表示されている場合は自動更新

### 🛠️ コード分離 & 保守性向上（2025/09/17 実装）
- **外部スクリプト分離**: 1,200行のインラインJavaScriptを`/scripts/sphere10.js`に完全分離
- **モジュール化実現**: HTMLとJavaScriptの明確な分離により保守性大幅向上
- **ファイル構造改善**: 
  - `index.html`: HTML構造のみに特化（約240行）
  - `scripts/sphere10.js`: 全JavaScript機能（約1,980行）
  - `scripts/chart.js`: ホロスコープチャート機能（約330行）
- **読み込み最適化**: 外部スクリプトによるキャッシュ効率向上
- **開発効率向上**: コードの検索・編集・デバッグが格段に便利

### 📁 改善されたファイル構成
```
├── index.html                    # メインHTML（整理済み・240行）
├── css/
│   ├── ui.css                   # [Update] グラスモーフィズムUIスタイル定義
│   └── chart.css                # ホロスコープチャート専用CSS
├── scripts/
│   ├── sphere10.js              # 3D描画コア、座標計算、メインループ
│   ├── timeControl.js           # [New] 日時操作UI、自動再生タイマー、レガシー連携ブリッジ
│   ├── chart.js                 # 2Dホロスコープ描画（独立モジュール）
│   └── astronomy.browser.min.js # 天文計算ライブラリ
├── data/
│   ├── bsc5.csv                 # 恒星データ
│   └── location.json            # 地理的位置データ
└── favicon_io/
    └── favicon.ico              # ファビコン
```

## 🚀 v1.9 既存機能（継続サポート）

### 📱 完全タッチデバイス対応（2025/09/17 実装）
- **タッチイベント統合**: 全トグルボタンに `touchstart` と `click` イベントを両対応
- **視覚フィードバック強化**: タッチ時に背景透明度0.2の控えめなフィードバック
- **iOS/Android最適化**: iPadやiPhoneでのタッチ操作性を大幅改善
- **オリジナルデザイン保持**: 美しいUI設計を維持しつつタッチ機能を追加

### 🌐 天文座標系機能拡張（2025/09/17 実装）
- **赤緯グリッド追加**: -80° ～ +80° の10度間隔で赤緯線を表示
- **視覚的区別**: 赤道線より暗い赤色（#cc3333）の点線で描画
- **教育的価値**: 天の座標系の理解を深める実用的ツール
- **表示制御**: 指標セクションに「赤緯 DEC」チェックボックスを追加
- **設定記憶**: 赤緯表示状態も localStorage で自動保存・復元

### 🛠️ 技術的改良点
- **Canvas 2D最適化**: 既存の高速描画システムと統合
- **パフォーマンス維持**: バッチ処理により描画負荷を最小化
- **回転適応**: 動的品質調整により回転中も滑らか
- **メモリ効率**: 既存の最適化手法を継承・発展

## ✨ v1.8.1 既存機能

### 📱 完全統一トグル機能
- **全セクション対応**: 「場所 Location」を含む全ての操作パネルセクションにトグル機能を統一
- **クリック可能ヘッダー**: 全ての h3 見出しがクリック可能なトグルボタンに変換
- **視覚的フィードバック**: ▼/▶ アイコンによる折りたたみ状態の明確な表示
- **状態記憶**: localStorage による各セクションの開閉状態の自動保存・復元
- **スムーズアニメーション**: 0.4秒の滑らかな展開・収納アニメーション

## ✨ v1.8 新機能・アップグレード内容

### 🧠 新機能: 設定値記憶機能
- **自動保存**: すべての設定値をlocalStorageに自動保存
- **自動復元**: 次回アクセス時に前回の設定を自動復元
- **リアルタイム同期**: 設定変更時に即座に保存され、UI要素も同期更新
- **エラーハンドリング**: localStorage無効時の安全な処理

### 🌍 緯度調節機能
- **緯度直接入力**: 数値入力による緯度の直接調節（-90° ～ +90°）
- **リアルタイム更新**: 緯度変更時に天体位置が即座に再計算
- **既存機能との連携**: 都市選択時に緯度入力フィールドも自動更新
- **入力値検証**: 範囲外の値の自動補正（±89.9999°に制限）

### 🖱️ インタラクティブ機能強化
- **ドラッグ移動機能**: Control Panelを画面上で自由に移動可能
- **統一されたボタンデザイン**: トグルボタンのサイズを統一（+/-表示）
- **英語ボタンラベル**: PLAY, STOP, FF, REWIND で国際対応
- **青系度数表示**: スライダー値を視認性の高い青色で表示
- **光るチェックボックス**: ON時に美しいグロー効果

### 🎨 洗練されたUIデザイン
- **モダンなコントロールパネル**: ガラスモーフィズムデザイン採用
- **グラデーション効果**: 視覚的に美しいカラーグラデーション
- **ブラー効果**: backdrop-filterによる洗練された背景効果
- **スムーズなアニメーション**: 全ての要素にスムーズな遷移効果

### 🎛️ 改善された操作要素
- **カスタムチェックボックス**: ✓マーク付きのモダンなデザイン + グロー効果
- **改良されたスライダー**: 美しいサムネイルと青系度数表示
- **スタイリッシュなボタン**: グラデーション効果とホバーアニメーション
- **改善されたトグルボタン**: 統一サイズの`+`/`−`表示

### 📱 レスポンシブ対応
- **モバイルフレンドリー**: 小さな画面でも使いやすいUI
- **適応的レイアウト**: 画面サイズに応じた自動調整
- **タッチ操作対応**: モバイルデバイスでの操作性向上

## 🚀 現在実装済みの機能

### コントロールパネル機能
- **ドラッグ移動**: ヘッダー部分をドラッグして画面上で自由に移動可能（位置記憶）
- **パネル表示/非表示切り替え**: 統一サイズの`−`/`+`ボタンによる折りたたみ機能
- **再生コントロール**: PLAY、STOP、FF（早送り）、REWIND（逆再生）
- **回転制御**: 水平・南北の回転スライダー（青系度数表示・角度記憶）
- **位置設定**: 緯度の直接入力による観測地点の設定（緯度値記憶）
- **表示オプション**: 各種天体要素の表示切り替え（光るチェックボックス・状態記憶）
  - 地平線 (Horizon)
  - 子午線 (Meridian)  
  - 赤道 (Equator)
  - 黄道 (Ecliptic)
  - 獣帯 (Zodiac)
  - 赤経 (RA)
  - 赤緯 (DEC)
  - 高度グリッド (Alt Grid)
  - 天頂・天底 (Zenith/Nadir)

### 日付操作機能（v2.0新機能）
- **日付入力**: datetime-local入力による任意の日時設定
- **手動日付送り**: 
  - ◀ボタン: 1日戻る
  - ▶ボタン: 1日進む
- **自動日付送り**: 
  - ◀◀ボタン: 0.5秒ごとに1日ずつ自動巻き戻し
  - ▶▶ボタン: 0.5秒ごとに1日ずつ自動送り
- **停止**: ■ボタンで自動送りを停止
- **リセット**: Todayボタンで現在時刻に戻る
- **chartCanvas連携**: 日付変更時にホロスコープチャートも自動更新

### 天体表示機能
- **恒星表示**: 固定星の表示/非表示
- **惑星位置**: 惑星の位置計算と表示
- **惑星ラベル**: 惑星名表示の切り替え
- **透明化機能**: 背景の透明表示
- **反転表示**: 東西反転機能
- **方角表示**: 方角情報の表示切り替え

### ホロスコープチャート機能
- **chartCanvas**: ホロスコープチャートの表示
- **黄経・黄緯表示**: 惑星の黄道座標を視覚化
- **日付連動**: 日付送り機能と自動連携
- **パフォーマンス最適化**: 非表示時は更新をスキップ

### インタラクション
- **マウスドラッグ操作**: 天球の直感的な回転操作
- **タッチ操作**: iPadやスマートフォンでのピンチ・ドラッグ対応
- **日時設定**: 任意の日時での天体位置表示
- **位置設定**: 
  - 都市選択による地理的位置設定（横浜市がデフォルト）
  - 緯度の直接数値入力（-90° ～ +90°）

## 🛠️ 技術仕様

### ファイル構成
```
├── index.html                    # メインHTML（整理済み・240行）
├── css/
│   ├── ui.css                   # UIスタイル + タッチ対応 + 日付送りボタン
│   └── chart.css                # ホロスコープチャート専用CSS
├── scripts/
│   ├── sphere10.js              # メインロジック（1,980行）
│   ├── chart.js                 # ホロスコープチャート（330行）
│   └── astronomy.browser.min.js # 天文計算ライブラリ（要配置）
├── data/
│   ├── bsc5.csv                 # 恒星データ（要配置）
│   └── location.json            # 地理的位置データ（要配置）
└── favicon_io/
    └── favicon.ico              # ファビコン（要配置）
```

### 使用技術
- **HTML5**: セマンティックな構造
- **CSS3**: モダンなスタイリング（Grid、Flexbox、CSS Variables）
- **JavaScript ES6+**: インタラクティブ機能
- **Astronomy Engine**: 天体位置計算
- **Canvas API**: 天球の描画

### CSSデザイン特徴
- **ガラスモーフィズム**: `backdrop-filter: blur()`
- **グラデーション**: `linear-gradient()`
- **ボックスシャドウ**: 複数層の影効果
- **カスタムフォーム要素**: `appearance: none`による完全カスタマイズ
- **スムーズトランジション**: `cubic-bezier()`イージング
- **グロー効果アニメーション**: `@keyframes`によるチェックボックス光彩
- **ドラッグ機能**: `cursor: grab/grabbing`による直感的操作
- **レスポンシブデザイン**: メディアクエリ対応

### 設定値記憶技術仕様
- **ストレージ方式**: localStorage（クライアントサイド永続化）
- **データ形式**: JSON形式での軽量保存
- **保存タイミング**: 各設定変更時のリアルタイム自動保存
- **復元タイミング**: ページ読み込み完了後の自動復元
- **エラー処理**: localStorage無効時の安全な処理
- **容量**: 設定データ約1KB程度（制限内で十分）

### 日付送り機能の技術仕様
- **日付ステップ**: 1日（24時間）
- **自動送り間隔**: 0.5秒（500ms）
- **タイマー管理**: setInterval/clearIntervalによる制御
- **イベント連携**: changeイベントによるchartCanvas更新
- **UIフィードバック**: activeクラスによるボタン状態管理

## 🔧 セットアップ手順

1. **必要ファイルの配置**:
   - `scripts/astronomy.browser.min.js` - 天文計算ライブラリ
   - `scripts/chart.js` - ホロスコープチャート機能
   - `data/bsc5.csv` - 恒星カタログデータ
   - `data/location.json` - 地理的位置データ
   - `favicon_io/favicon.ico` - アプリケーションアイコン

2. **Webサーバーでの実行**:
   - ローカルサーバーまたはWebサーバーで`index.html`を開く
   - ファイルプロトコル(`file://`)では正常に動作しない場合があります

3. **推奨環境**:
   - モダンブラウザ（Chrome、Firefox、Safari、Edge）
   - JavaScript有効
   - localStorage有効

## 🎯 デザインの制約事項

### ✅ アップグレード対象
- 操作パネルの表示・非表示トグル
- フォーム要素（スライダー、チェックボックス、ボタン）のデザイン
- 操作系ボタンの視覚的改善
- 日付送り機能のUI統合

### ❌ 保持された要素（変更なし）
- 天体表示ロジック
- 天文情報（恒星、惑星、天球、赤道、黄道など）の計算
- 基本的な機能ロジック
- キャンバス描画処理

## 🌟 今後の拡張可能性

### 推奨される次のステップ
1. **タイムゾーン対応**: 観測地のタイムゾーン設定機能
2. **経度入力UI**: 緯度と対になる経度入力フィールド
3. **日付ステップのカスタマイズ**: 1時間、1週間、1ヶ月単位での送り
4. **速度調整**: 自動送りの速度を可変にする機能
5. **テーマシステム**: ライト/ダークモードの切り替え
6. **アクセシビリティ向上**: WAI-ARIA対応とキーボードナビゲーション

### 技術的改善点
- CSS Variables活用によるテーマ機能
- Web Components化によるモジュール性向上
- PWA対応によるオフライン機能
- WebGL使用による3D描画高速化

## 📞 お問い合わせ

- **フィードバック**: [Google Form](https://forms.gle/gUFJBuh3cxngWHYo6)
- **ウェブサイト**: astrogrammar.com

---

**バージョン**: v2.0 Date Navigation Enhanced  
**最終最終更新: 2025-12-15  
**ライセンス**: オリジナルライセンスに準拠

## 🎮 操作方法

### Control Panel移動
- Control Panelのヘッダー部分（タイトル部分）をドラッグして画面上で自由に移動できます
- トグルボタン(`−`/`+`)以外の部分をクリック&ドラッグしてください

### 日付操作（v2.0新機能）
- **◀◀**: 自動巻き戻し（0.5秒ごとに1日ずつ過去へ）
- **◀**: 1日戻る
- **■**: 自動送りを停止
- **▶**: 1日進む
- **▶▶**: 自動送り（0.5秒ごとに1日ずつ未来へ）
- **Today**: 現在時刻にリセット

### 記憶される設定値
- **位置情報**: 緯度設定値
- **回転角度**: 水平・南北・東西の全回転角度
- **表示設定**: 全チェックボックスの状態（地平線、子午線、赤道、黄道、獣帯、赤経、赤緯、高度グリッド、天頂・天底、恒星、透明化、惑星ラベル、反転、方角）
- **パネル状態**: コントロールパネルの表示/非表示状態
- **日付送り状態**: 最後に設定した日時（自動復元はされません）

### UI機能の特徴
- **緯度直接入力**: 数値入力による精密な緯度設定（0.1度単位）
- **青系度数表示**: スライダーの度数値が青色で視認性が向上
- **光るチェックボックス**: ONの時に美しい緑色のグロー効果
- **統一ボタンサイズ**: トグルボタンが常に同じ小さなサイズ
- **英語ボタンラベル**: 国際対応のための英語表記
- **日付送りボタン**: 音楽プレーヤー風の直感的なデザイン