<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sphere10 Reset</title>
<link rel="stylesheet" href="css/ui.css" />
<style>
body {
  background: radial-gradient(circle at center, #0a0a0a 0%, #000 100%);
  color: #cbd5e1;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  overflow: hidden;
  opacity: 0;
  animation: fadeIn 1.2s ease forwards;
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.98); }
  to { opacity: 1; transform: scale(1); }
}

.spinner {
  border: 6px solid rgba(255, 255, 255, 0.15);
  border-top: 6px solid #3b82f6;
  border-radius: 50%;
  width: 72px;
  height: 72px;
  animation: spin 1s linear infinite;
  margin-bottom: 24px;
}
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

h1 {
  font-size: 18px;
  font-weight: 600;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
  color: #e2e8f0;
}
p {
  font-size: 13px;
  opacity: 0.8;
  line-height: 1.6;
  margin: 0 20px;
}
.success {
  color: #10b981;
  text-shadow: 0 0 8px rgba(16,185,129,0.5);
}
.error {
  color: #ef4444;
  text-shadow: 0 0 8px rgba(239,68,68,0.5);
}
.fadeout {
  animation: fadeOut 1.5s ease forwards;
}
@keyframes fadeOut {
  from { opacity: 1; transform: scale(1); }
  to { opacity: 0; transform: scale(0.97); }
}
</style>
</head>
<body>
  <div class="spinner"></div>
  <h1>Sphere10 を初期化中…</h1>
  <p>設定・キャッシュ・GPUメモリをリセットしています。<br>この処理には約3〜5秒かかります。</p>

<script>
(async () => {
  const delay = (ms) => new Promise(r => setTimeout(r, ms));

  try {
    console.log("[Sphere10 Reset] Start full reset");

    // ====== 1️⃣ localStorage / sessionStorage / store ======
    localStorage.clear();
    sessionStorage.clear();
    if (typeof store !== "undefined" && store && typeof store.clear === "function") {
      try { store.clear(); } catch(e) { console.warn("store.clear() failed", e); }
    }

    // ====== 2️⃣ CacheStorage ======
    if ("caches" in window) {
      const keys = await caches.keys();
      for (const key of keys) await caches.delete(key);
    }

    // ====== 3️⃣ IndexedDB ======
    if (window.indexedDB && indexedDB.databases) {
      const dbs = await indexedDB.databases();
      for (const db of dbs) {
        try { indexedDB.deleteDatabase(db.name); } 
        catch(e) { console.warn("IndexedDB delete failed:", db.name, e); }
      }
    }

    // ====== 4️⃣ ServiceWorker ======
    if (navigator.serviceWorker) {
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const reg of regs) await reg.unregister();
    }

    // ====== 5️⃣ Safari GPUキャッシュ flush ======
    const flushSafariGPU = () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      if (ctx && typeof ctx.reset === 'function') ctx.reset();
      for (let i = 0; i < 300; i++) {
        ctx.fillStyle = `rgba(${Math.random()*255},${Math.random()*255},${Math.random()*255},0.2)`;
        ctx.fillRect(Math.random()*2000, Math.random()*2000, 50, 50);
      }
      canvas.width = canvas.height = 1;
      canvas.remove();
      console.log("[Safari GPU flush] Metal PathCache overwritten");
    };
    flushSafariGPU();

    // ====== 6️⃣ Canvas再生成でGC誘発 ======
    for (let i = 0; i < 20; i++) document.createElement("canvas");

    // ====== 7️⃣ 再描画フェード効果 ======
    document.body.style.opacity = "0.85";
    await delay(150);
    document.body.style.opacity = "1";

    // ====== 8️⃣ 完了表示 + フェードアウト後に再起動 ======
    document.querySelector("h1").textContent = "初期化完了";
    document.querySelector("p").innerHTML = '<span class="success">Sphere10 が完全にリセットされました。</span><br>まもなく再起動します…';
    await delay(1800);
    document.body.classList.add('fadeout');
    await delay(1400);
    window.location.replace("index.html");

  } catch (err) {
    console.error("[Sphere10 Reset] Error:", err);
    document.querySelector("h1").textContent = "リセットエラー";
    document.querySelector("p").innerHTML = '<span class="error">一部のキャッシュを削除できませんでした。</span><br>ブラウザを再起動してください。';
  }
})();
</script>
</body>
</html>
