# 天球指定日時表示機能 実装規模推定レポート

**信頼度**: 80%  
**作成日**: 2025-11-06

---

## 📊 現状分析

### sphere10.jsの現在の状況
- **総行数**: 1,816行
- **主要機能**: 3D天球レンダリング、惑星位置計算、UI制御、日付送り機能
- **既存の日時関連機能**:
  - ✅ `currentDate`変数（グローバル日時管理）
  - ✅ `datetimeInput`（HTML5 datetime-local入力）
  - ✅ 日付送り機能（◀◀/◀/■/▶/▶▶/Today）
  - ✅ `updateAllPositions()`（日時変更時の惑星位置再計算）
  - ✅ Astronomy Engineライブラリ連携

### 既存の観測地情報機能
- ✅ `latitude`, `longitude`変数
- ✅ `latitudeInput`（緯度入力フィールド）
- ✅ `setLocationButton`（都市名から座標取得）
- ✅ `Astronomy.Observer`（観測者位置設定）
- ❌ タイムゾーン機能（**未実装**）

---

## 🎯 追加が必要な機能

### 1. タイムゾーン対応
**現状**: JavaScriptの`Date`オブジェクトはブラウザのローカルタイムゾーンを使用  
**必要な実装**:
- タイムゾーン選択UI（ドロップダウンまたは入力フィールド）
- タイムゾーンオフセット計算
- UTC変換処理
- 表示時刻のタイムゾーン表示

**推定行数**: 80-120行
- UI要素: 10-15行（HTML）
- タイムゾーンリスト/ロジック: 40-60行
- 日時変換処理: 30-45行

### 2. 経度入力UI
**現状**: 緯度入力は実装済み、経度は都市選択でのみ設定可能  
**必要な実装**:
- 経度入力フィールド（`longitudeInput`）
- バリデーション（-180〜180度）
- `updateAllPositions()`との連携

**推定行数**: 30-50行
- UI要素: 5-10行（HTML）
- イベントリスナー: 15-25行
- バリデーション: 10-15行

### 3. 日時入力の拡張
**現状**: `datetime-local`入力は実装済み  
**必要な実装**:
- 秒単位の入力対応（現在は分まで）
- タイムゾーン表示の統合
- 入力フォーマットの改善

**推定行数**: 20-40行

### 4. 設定の永続化
**現状**: `localStorage`で緯度・回転角度などを保存済み  
**必要な実装**:
- タイムゾーン設定の保存
- 経度設定の保存（現在は未保存）
- デフォルト日時設定の保存（オプション）

**推定行数**: 15-25行

---

## 📈 コード増加率の推定

### 合計推定増加行数
| 機能 | 最小 | 最大 | 平均 |
|------|------|------|------|
| タイムゾーン対応 | 80 | 120 | 100 |
| 経度入力UI | 30 | 50 | 40 |
| 日時入力拡張 | 20 | 40 | 30 |
| 設定永続化 | 15 | 25 | 20 |
| **合計** | **145** | **235** | **190** |

### コード増加率
- **現在の行数**: 1,816行
- **追加行数（平均）**: 190行
- **増加率**: **190 ÷ 1,816 = 10.5%**

**推定範囲**: 8% 〜 13%

---

## 🔧 ファイル分割の推奨

### 結論: **分割は不要**

**理由**:

1. **増加率が小さい**: 10.5%の増加は、ファイル分割を必要とするほどの規模ではない
   - 一般的に20-30%以上の増加で分割を検討

2. **機能の密結合**: 
   - タイムゾーン・観測地情報は`updateAllPositions()`と密接に連携
   - `currentDate`, `latitude`, `longitude`はsphere10.js内のグローバル変数
   - 分割すると変数スコープの管理が複雑化

3. **既存の設計**: 
   - sphere10.jsは既に1,816行で、適切に構造化されている
   - `initApp()`関数内でスコープ管理されており、追加機能も同様に統合可能

4. **保守性**: 
   - 日時・観測地関連の機能が1ファイルに集約されている方が保守しやすい
   - デバッグ時に複数ファイルを横断する必要がない

### 代替案: コメントブロックでの区分け

ファイル分割の代わりに、既存の構造に倣って**コメントブロック**で機能を区分けすることを推奨:

```javascript
// ★★★ タイムゾーン管理機能 ★★★
let timezone = 'Asia/Tokyo'; // デフォルト
let timezoneOffset = 9; // UTC+9

function updateTimezone(tz) {
    // タイムゾーン変更処理
}

// ★★★ 観測地情報管理 ★★★
let latitude = 35.4333;
let longitude = 139.65;

function updateObserverLocation(lat, lon) {
    // 観測地更新処理
}
```

---

## 📋 実装優先度

### Phase 1（必須）
1. ✅ **経度入力UI** - 緯度と対になる基本機能
2. ✅ **設定永続化（経度）** - ユーザー体験向上

### Phase 2（推奨）
3. ⚠️ **タイムゾーン対応** - 国際対応に必要
4. ⚠️ **日時入力拡張** - 精密な時刻設定

### Phase 3（オプション）
5. 💡 **デフォルト日時設定** - 起動時の日時を保存
6. 💡 **観測地プリセット** - よく使う観測地を保存

---

## 🎯 実装方針の推奨

### 推奨アプローチ
1. **sphere10.js内に統合実装**
   - ファイル分割は不要
   - コメントブロックで機能を明確に区分
   - 既存の`initApp()`関数内で実装

2. **段階的実装**
   - Phase 1から順に実装
   - 各フェーズでテスト・コミット
   - 機能ごとにブランチを分ける

3. **既存パターンの踏襲**
   - 緯度入力UIと同様の実装パターンを経度にも適用
   - `saveSettings()`/`loadSettings()`を拡張
   - `updateAllPositions()`との連携を維持

### 将来的な分割の検討タイミング
以下の条件を満たす場合は分割を再検討:
- sphere10.jsが**2,500行を超える**
- **独立した大規模機能**（例: 軌道計算エンジン）を追加
- **複数の開発者**が同時に編集する必要がある

---

## 📊 まとめ

| 項目 | 推定値 |
|------|--------|
| **コード増加率** | **10.5%**（8-13%の範囲） |
| **追加行数** | 190行（145-235行の範囲） |
| **ファイル分割** | **不要** |
| **実装場所** | sphere10.js内に統合 |
| **実装方法** | コメントブロックで区分け |

**結論**: 天球指定日時表示機能の追加は、sphere10.jsのコード量を約10.5%増加させる程度の規模であり、ファイル分割は不要です。既存の構造に統合する形で実装することを推奨します。

---

**信頼度**: 80%  
**根拠**: 既存コードの詳細分析、類似機能の実装パターン、一般的なソフトウェア設計原則に基づく推定
